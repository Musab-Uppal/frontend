<div class="p-6 space-y-4">
    <!-- TOAST NOTIFICATIONS -->
    <p-toast position="top-right"></p-toast>

    <!-- Toolbar + Filter Chips (single section) -->
    <div class="bg-white rounded-2xl p-5 mb-4">
        <!-- Top row: Search + Buttons + Count + Run Automation -->
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-3">
                <!-- Search input with icon -->
                <div class="relative !rounded-2xl">
                    <input
                        type="text"
                        pInputText
                        [(ngModel)]="searchText"
                        placeholder="Search Message ID"
                        class="p-inputtext-sm w-64 bg-gray-100 border border-gray-200 pl-10 focus:ring-2 focus:ring-gray-300"
                    />
                    <i class="pi pi-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <button
                    pButton
                    label="Add New"
                    icon="pi pi-plus"
                    class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-3 !text-black !border-none"
                    (click)="manualTable?.addNewRow()">
                </button>

                <button
                    pButton
                    label="Run Rules"
                    icon="pi pi-cog"
                    class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-3 !text-black !border-none"
                    (click)="openRunRulesDialog()">
                </button>

                <button
                    pButton
                    label="Filters"
                    icon="pi pi-filter"
                    class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-3 !text-black !border-none"
                    (click)="showFilters()">
                </button>

                <button
                    pButton
                    label="Import via Excel"
                    icon="pi pi-upload"
                    class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-3 !text-black !border-none"
                    (click)="openImportDialog()">
                </button>

                <button
                    pButton
                    label="Sorting"
                    icon="pi pi-sort-alt"
                    class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-3 !text-black !border-none"
                    (click)="showSortingDialog()">
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-600">
                    Total Count: <strong>{{ tableData.length }}</strong>
                </div>
                <!-- Run Automation Dropdown -->
                <div class="relative">
                    <button
                        pButton
                        label="âœ¨Run Automation"
                        
                        class="p-button-sm !bg-gray-900 hover:!bg-black !text-white !border-none !rounded-full !px-5 !py-2.5"
                        (click)="showAutomationMenu = !showAutomationMenu"
                        [disabled]="runningAutomation">
                    </button>
                    <!-- Backdrop -->
                    <div *ngIf="showAutomationMenu" class="fixed inset-0 z-40" (click)="showAutomationMenu = false"></div>
                    <!-- Menu -->
                    <div *ngIf="showAutomationMenu"
                        class="absolute right-0 top-full mt-1 bg-white shadow-lg rounded-lg border border-gray-200 z-50 w-56 overflow-hidden">
                        <button (click)="runAutomation(false)"
                            class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-b border-gray-100">
                            <i class="pi pi-play text-green-600"></i>
                            Run Automation
                        </button>
                        <button (click)="runAutomation(true)"
                            class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                            <i class="pi pi-refresh text-blue-600"></i>
                            Override Cron &amp; Run
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Divider -->
        <div class="my-4 border-t border-gray-200"></div>

        <!-- Bottom row: Filter chips + Undo / Presets -->
        <div class="flex flex-wrap items-center gap-3">
            <!-- Filter chips -->
            <ng-container *ngIf="activeFilters.length > 0">
                <div *ngFor="let filter of activeFilters; let i = index"
                    class="flex items-center gap-3 px-5 py-2.5 rounded-full bg-gray-100 text-gray-900 border border-gray-200">
                    <i class="pi pi-filter text-gray-700"></i>
                    <span class="text-sm font-medium whitespace-nowrap">
                        {{ filter.columnDisplay }} : {{ filter.operatorDisplay }} {{ filter.values }}
                        <span *ngIf="filter.values2"> - {{ filter.values2 }}</span>
                    </span>
                    <button class="text-red-500 hover:text-red-600" aria-label="Remove filter"
                        (click)="removeFilter(i)">
                        <i class="pi pi-times"></i>
                    </button>
                </div>

                <button
                    class="flex items-center gap-2 rounded-full px-5 py-2.5 bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"
                    (click)="removeAllActiveFilters()">
                    <i class="pi pi-trash text-sm"></i>
                    Remove all filters
                </button>
            </ng-container>

            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- Undo button -->
            <button
                pButton
                label="Undo"
                icon="pi pi-undo"
                class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-2.5 !text-black !border-none"
                (click)="undoLastAction()">
            </button>

            <!-- Presets button -->
            <button
                pButton
                icon="pi pi-sliders-h"
                class="p-button-sm !bg-gray-100 !rounded-2xl hover:bg-gray-200 !px-5 !py-2.5 !text-black !border-none"
                (click)="showPresetsDialog()">
                <span class="ml-2">{{ presetCount }} Presets</span>
            </button>
        </div>
    </div>

    <!-- CUSTOM TABLE - EDITABLE -->
    <app-custom-table
        #manualTable
        [columns]="tableColumns"
        [data]="tableData"
        [config]="tableConfig"
        (dataChanged)="onTableDataChanged($event)"
        (rowsSelected)="onTableRowsSelected($event)"
        (cellEdited)="onCellEdited($event)"
        (onExpandButtonClick)="toggleTableExpansion()">
    </app-custom-table>

    <!-- ============ IMPROVED FILE IMPORT DIALOG ============ -->
    <p-dialog 
        header="Manual Color Import"
        [(visible)]="showImportDialog" 
        [modal]="true" 
        [style]="{'width': '500px'}" 
        [closable]="true"
        [showHeader]="true"
        class="import-dialog">
        
        <div class="import-dialog-content">
            <!-- Description -->
            <p class="text-sm text-gray-600 mb-6 font-medium">
                Add manual color excel files, you can upload up to 5 excel files
            </p>

            <!-- Drop Zone -->
            <div class="drop-zone" *ngIf="!selectedFile || !isUploading">
                <div class="drop-zone-content">
                    <!-- Loading spinner -->
                    <p-progressSpinner 
                        *ngIf="isUploading"
                        [style]="{width: '50px', height: '50px'}" 
                        strokeWidth="4"
                        class="mb-4">
                    </p-progressSpinner>

                    <!-- Upload icon (when not loading) -->
                    <i 
                        *ngIf="!isUploading"
                        class="pi pi-cloud-upload text-3xl text-green-500 mb-3">
                    </i>

                    <!-- Status text -->
                    <p class="text-sm font-medium text-gray-700 mb-2">
                        {{ isUploading ? 'Uploading...' : 'Drop your file here' }}
                    </p>

                    <!-- Native file input (hidden) -->
                    <input 
                        *ngIf="!isUploading"
                        #fileInputRef
                        type="file"
                        accept=".xlsx,.xls"
                        style="display: none;"
                        (change)="onNativeFileSelect($event)">

                    <!-- Browse button -->
                    <button 
                        *ngIf="!isUploading"
                        pButton 
                        label="Browse Files"
                        icon="pi pi-folder-open"
                        class="p-button-outlined p-button-sm browse-btn"
                        (click)="triggerFileInput()">
                    </button>
                </div>
            </div>

            <!-- File info (when file is selected) -->
            <div *ngIf="selectedFile && !isUploading" class="file-info-section">
                <div class="file-info-box">
                    <div class="file-info-left">
                        <i [class]="'pi ' + getFileIcon() + ' text-2xl text-blue-500'"></i>
                    </div>
                    <div class="file-info-details">
                        <p class="file-name">{{ selectedFile.name }}</p>
                        <p class="file-size">{{ fileSize }}</p>
                    </div>
                    <button 
                        pButton 
                        icon="pi pi-times"
                        class="p-button-text p-button-sm remove-file-btn"
                        (click)="onCancelUpload()"
                        pTooltip="Remove file">
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="divider"></div>

            <!-- Info text -->
            <p class="text-xs text-gray-500 text-center mb-6">
                Only support .xlsx or .csv extensions
            </p>

            <!-- Action Buttons -->
            <div class="dialog-actions">
                <button 
                    pButton 
                    label="Cancel" 
                    icon="pi pi-times"
                    class="p-button-outlined p-button-sm cancel-btn"
                    (click)="onCancelUpload()"
                    [disabled]="isUploading">
                </button>
                
                <button 
                    pButton 
                    label="Import"
                    icon="pi pi-upload"
                    class="p-button-sm import-btn"
                    (click)="onUpload()"
                    [disabled]="!selectedFile || isUploading">
                </button>
            </div>
        </div>
    </p-dialog>

    <!-- ============ RUN RULES DIALOG ============ -->
    <p-dialog
        header="Rules"
        [(visible)]="showRunRulesDialog"
        [modal]="true"
        [style]="{'width': '520px'}"
        [closable]="true"
        class="run-rules-dialog">

        <div class="run-rules-content">
            <!-- Preset Loader -->
            <div class="mb-4">
                <label class="text-xs font-medium text-gray-500 mb-1 block">Load Preset</label>
                <select [(ngModel)]="selectedPresetId" (ngModelChange)="$event && applyPreset($event)"
                    class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <option [ngValue]="null">-- Select a preset --</option>
                    <option *ngFor="let preset of availablePresets" [ngValue]="preset.id">
                        {{ preset.name }} ({{ preset.conditions.length }} filters)
                    </option>
                </select>
            </div>

            <!-- Search -->
            <div class="relative mb-4">
                <input
                    type="text"
                    pInputText
                    [(ngModel)]="ruleSearchText"
                    placeholder="Search rules..."
                    class="w-full p-inputtext-sm !bg-gray-50 !border !border-gray-200 !pl-10 !rounded-lg">
                <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Loading -->
            <div *ngIf="loadingRules" class="flex justify-center py-8">
                <p-progressSpinner [style]="{width: '40px', height: '40px'}" strokeWidth="4"></p-progressSpinner>
            </div>

            <!-- Rules Table -->
            <div *ngIf="!loadingRules" class="rules-list-container max-h-[350px] overflow-y-auto">
                <table class="w-full">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-2 px-3 text-sm font-medium text-gray-500 w-10">
                                <input type="checkbox"
                                    [checked]="allFilteredRulesSelected"
                                    (change)="toggleSelectAll()"
                                    class="cursor-pointer w-4 h-4 accent-gray-900">
                            </th>
                            <th class="text-left py-2 px-3 text-sm font-medium text-gray-500">Rule Name</th>
                            <th class="text-center py-2 px-3 text-sm font-medium text-gray-500 w-20">Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let rule of filteredRules"
                            class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                            (click)="toggleRuleSelection(rule.id)">
                            <td class="py-3 px-3">
                                <input type="checkbox"
                                    [checked]="isRuleSelected(rule.id)"
                                    (click)="$event.stopPropagation()"
                                    (change)="toggleRuleSelection(rule.id)"
                                    class="cursor-pointer w-4 h-4 accent-gray-900">
                            </td>
                            <td class="py-3 px-3 text-sm text-gray-800 font-medium">{{ rule.name }}</td>
                            <td class="py-3 px-3 text-center">
                                <span class="inline-block w-2.5 h-2.5 rounded-full"
                                    [class.bg-green-500]="rule.is_active"
                                    [class.bg-gray-300]="!rule.is_active">
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Empty state -->
                <div *ngIf="filteredRules.length === 0" class="text-center py-8 text-gray-500 text-sm">
                    {{ ruleSearchText ? 'No rules matching search' : 'No rules configured. Go to Settings to create rules.' }}
                </div>
            </div>

            <!-- Selected count -->
            <div *ngIf="!loadingRules && availableRules.length > 0" class="mt-3 text-xs text-gray-500">
                {{ selectedRuleIds.size }} of {{ availableRules.length }} rule(s) selected
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200">
                <button pButton label="Cancel"
                    class="p-button-outlined p-button-sm cancel-btn"
                    (click)="cancelRunRules()"
                    [disabled]="runningRules">
                </button>
                <button pButton label="Run"
                    icon="pi pi-play"
                    class="p-button-sm !bg-gray-900 !border-gray-900 hover:!bg-black"
                    (click)="runSelectedRules()"
                    [disabled]="runningRules || selectedRuleIds.size === 0">
                </button>
            </div>
        </div>
    </p-dialog>

    <!-- Filter Dialog Component -->
    <app-filter-dialog
        [(visible)]="showFilterDialog"
        (filtersApplied)="onFiltersApplied($event)">
    </app-filter-dialog>

    <!-- ================= EXPANDED TABLE VIEW ================= -->
    <div *ngIf="isTableExpanded" class="fixed inset-0 bg-white z-40 flex flex-col"
        [ngStyle]="{'padding-top': '64px', 'padding-left': '0px'}">
        <!-- MINIMIZE BUTTON AT TOP-RIGHT -->
        <div class="absolute top-6 right-6 z-50">
            <button pButton icon="pi pi-compress"
                class="minimize-table-btn !bg-gray-900 !text-white hover:!bg-black !border !border-gray-900 !w-10 !h-10 !p-0 !rounded-lg"
                (click)="toggleTableExpansion()" 
                pTooltip="Minimize table" 
                tooltipPosition="left">
            </button>
        </div>

        <!-- SEARCH / FILTERS BAR IN EXPANDED VIEW (at top) -->
        <div class="bg-white border-b border-gray-200 p-5">
            <div class="max-w-[1800px] mx-auto">
                <!-- Top Controls -->
                <div class="flex flex-col sm:flex-row flex-wrap items-center gap-4">
                    <!-- Search -->
                    <div class="relative w-full sm:w-64">
                        <input pInputText type="text" placeholder="Search Message ID"
                            class="w-full !rounded-full !px-5 !py-2.5 !bg-gray-50 !text-gray-700 !border !border-gray-300 hover:!bg-gray-100" />
                        <i
                            class="pi pi-search absolute right-5 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>

                    <!-- Spacer -->
                    <div class="flex-1"></div>

                    <!-- Total Count -->
                    <div
                        class="flex items-center gap-3 px-5 py-2.5 rounded-full border border-gray-300 bg-gray-50 text-gray-700 font-medium">
                        <span>Total Count</span>
                        <span class="px-3 py-0.5 bg-white rounded-full shadow text-sm font-semibold"> {{
                            tableData.length }} </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLE IN EXPANDED MODE -->
        <div class="flex-1 overflow-auto px-6 py-4">
            <app-custom-table [columns]="tableColumns" [data]="tableData" [config]="tableConfig"
                (dataChanged)="onTableDataChanged($event)" (rowsSelected)="onTableRowsSelected($event)"
                (onExpandButtonClick)="toggleTableExpansion()">
            </app-custom-table>
        </div>
    </div>
</div>